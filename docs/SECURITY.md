# gpasswd 安全模型

## 概述

gpasswd 采用零知识架构，所有加密和解密操作在本地完成，主密码和加密密钥永不离开你的设备。

---

## 加密实现细节

### 1. 密钥派生（Key Derivation）

```
主密码（用户输入）
    ↓
Argon2id 密钥派生函数
    ├─ 时间成本（Time Cost）: 3 次迭代
    ├─ 内存成本（Memory Cost）: 64 MB
    ├─ 并行度（Parallelism）: 4 线程
    └─ Salt: 32 字节随机值（初始化时生成）
    ↓
派生密钥（Derived Key）: 32 字节
```

**为什么选择 Argon2id？**

- **Argon2** 是 2015 年密码哈希竞赛的冠军
- **Argon2id** 结合了 Argon2i（抗侧信道攻击）和 Argon2d（抗 GPU 破解）
- 内存密集型设计，使暴力破解成本极高
- 比 PBKDF2 和 bcrypt 更安全

**参数选择理由**：

| 参数 | 值 | 说明 |
|------|----|----|
| Time Cost | 3 | 在现代 Mac 上约 100-200ms，平衡安全和体验 |
| Memory Cost | 64 MB | 足够抵御 GPU 攻击，不会占用过多内存 |
| Parallelism | 4 | 利用多核 CPU，加快派生速度 |
| Salt | 32 bytes | 防止彩虹表攻击，每个保管库唯一 |

### 2. 数据加密

```
明文数据（Entry JSON）
    ↓
AES-256-GCM 加密
    ├─ 密钥: Argon2id 派生的 32 字节密钥
    ├─ Nonce: 12 字节随机值（每个条目独立）
    └─ 附加认证数据（AAD）: Entry ID
    ↓
加密数据 + 认证标签
    ↓
存储到 SQLite 数据库
```

**为什么选择 AES-256-GCM？**

- **AES-256**: 军事级加密标准，密钥空间为 2^256
- **GCM 模式**:
  - 认证加密（AEAD），防止篡改
  - 高性能，硬件加速支持
  - 自动生成认证标签（16 字节）
- **Nonce**: 每次加密使用新的随机 Nonce，确保相同明文产生不同密文

**安全保证**：

1. **机密性**: 没有密钥无法解密数据
2. **完整性**: GCM 认证标签确保数据未被篡改
3. **抗重放攻击**: Nonce 确保每次加密唯一

### 3. Nonce 管理

```
每个 Entry 加密时:
    1. 生成 12 字节随机 Nonce (crypto/rand)
    2. Nonce 与密文一起存储
    3. 解密时使用相同 Nonce
```

**关键原则**：Nonce 在同一密钥下**永不重复使用**

- 使用 `crypto/rand.Read()` 生成真随机数
- 12 字节 Nonce 空间为 2^96，碰撞概率极低
- 即使加密相同内容，密文也完全不同

---

## 主密码要求

### 强度标准

```
最低要求（MVP）:
├─ 长度 ≥ 12 字符
├─ 包含大写字母
├─ 包含小写字母
├─ 包含数字
└─ 包含符号

推荐做法:
├─ 使用密码短语（4-5 个随机单词）
│   示例: "correct-horse-battery-staple"
└─ 或使用密码管理器生成的强密码
```

### 密码熵计算

| 密码类型 | 示例 | 熵（bits） | 暴力破解时间* |
|----------|------|-----------|--------------|
| 弱密码 | `Password123!` | ~40 | 几小时 |
| 中等密码 | `Xk9$mP2@vL4#` | ~70 | 数年 |
| 强密码 | `Xk9$mP2@vL4#nR8&qT3!` | ~100 | 数十亿年 |
| 密码短语 | `correct-horse-battery-staple` | ~50 | 数年 |

\* 假设攻击者拥有数据库文件和强大的破解设备（Argon2id 参数下）

**建议**：
- 使用 `gpasswd generate --length 20` 生成主密码
- 将主密码写在纸上，存放在安全地点（保险箱）
- 不要在其他地方重复使用主密码

---

## 会话管理

### 会话生命周期

```
用户输入主密码
    ↓
派生加密密钥（Argon2id，耗时 100-200ms）
    ↓
密钥存储在内存中（[]byte）
    ↓
启动会话定时器（默认 5 分钟）
    ↓
用户可执行多个操作，无需重新输入密码
    ↓
[超时 OR 手动 lock]
    ↓
清零内存中的密钥
    ↓
下次操作需重新输入主密码
```

### 会话超时配置

```yaml
# ~/.gpasswd/config.yaml
session:
  timeout: 300  # 秒，0 表示永不超时（不推荐）
```

**安全权衡**：
- **较短超时**（1-3 分钟）: 更安全，但频繁输入密码
- **较长超时**（10-15 分钟）: 更便利，但离开电脑时风险更高
- **推荐设置**: 5 分钟（平衡点）

**最佳实践**：
- 离开电脑时手动执行 `gpasswd lock`
- 在公共场所使用时设置较短超时
- 在家中私人电脑可适当延长

### 内存安全

```go
// 会话结束时清零密钥
defer func() {
    for i := range key {
        key[i] = 0
    }
    runtime.GC() // 触发垃圾回收
}()
```

**局限性**：
- Go 的垃圾回收器可能在内存中保留副本
- 操作系统可能将内存页交换到磁盘（swap）
- 内存转储攻击仍可能在会话期间获取密钥

**缓解措施**：
- 会话超时尽量短
- macOS 启用 FileVault 加密磁盘
- 关闭 swap 或使用加密 swap

---

## 剪贴板安全

### 自动清除机制

```
gpasswd copy "Gmail Work"
    ↓
解密密码
    ↓
复制到系统剪贴板（pbcopy）
    ↓
启动后台 goroutine
    ↓
等待 30 秒（可配置）
    ↓
检查剪贴板内容是否仍是该密码
    ↓
清空剪贴板（pbcopy < /dev/null）
    ↓
终端提示：✓ Clipboard cleared
```

### 配置

```yaml
# ~/.gpasswd/config.yaml
clipboard:
  clear_timeout: 30  # 秒，0 表示不清除（不推荐）
```

### 风险

⚠️ **剪贴板监控**：恶意软件可能监控剪贴板内容

**缓解**：
- 30 秒窗口期尽量短
- 粘贴密码后可手动清空剪贴板（`pbcopy < /dev/null`）
- 敏感环境使用 `gpasswd reveal` 在终端显示（避免剪贴板）

⚠️ **剪贴板历史**：某些工具（Alfred, Paste）会记录历史

**缓解**：
- 在这些工具中排除密码管理应用
- 或禁用剪贴板历史功能

---

## 数据库安全

### 存储位置

```
~/.gpasswd/
├── vault.db       # 加密的 SQLite 数据库
└── config.yaml    # 配置文件（不含敏感信息）
```

### 权限设置

```bash
# vault.db 权限应为 600（仅所有者可读写）
$ ls -l ~/.gpasswd/vault.db
-rw------- 1 user staff 12345 Jan 13 10:00 vault.db
```

初始化时自动设置：
```go
os.Chmod(dbPath, 0600)
```

### 数据库内容

| 表 | 字段 | 加密状态 |
|----|------|---------|
| metadata | salt | 明文（需要用于派生密钥） |
| metadata | argon2_params | 明文 |
| entries | encrypted_data | **加密**（AES-256-GCM） |
| entries | nonce | 明文（解密必需） |
| entries | search_text | **明文**（仅名称、分类、标签） |

**权衡说明**：

✅ **加密字段**:
- password（密码）
- username（用户名）
- url（网址）
- notes（备注）

⚠️ **明文字段**:
- name（条目名称，如 "Gmail Work"）
- category（分类，如 "email"）
- tags（标签，如 "work", "google"）

**为什么不全部加密？**
- 需要快速搜索（全文搜索需要明文）
- SQLite FTS5 不支持加密字段搜索
- 权衡：便利性 vs 隐私

**风险评估**：
- 如果攻击者获得数据库文件，可知道你有哪些账号（但看不到密码）
- 例如：可知道你有 Gmail、GitHub 账号

**缓解**：
- 使用模糊的条目名称（如 "Email 1" 而非 "Gmail"）
- 未来版本：考虑加密搜索方案（性能换隐私）

---

## 暴力破解防护

### 在线攻击防护

```
连续输入错误主密码
    ↓
失败次数 +1
    ↓
达到阈值（默认 5 次）
    ↓
锁定 30 秒（lockout_duration）
    ↓
记录到日志（可选）
    ↓
30 秒后重置计数器
```

**配置**：
```yaml
security:
  failed_attempts_limit: 5
  lockout_duration: 30  # 秒
```

**注意**：这仅防止实时在线攻击，不防御离线暴力破解。

### 离线攻击防护

**场景**：攻击者获得了 `vault.db` 文件副本

**防御层次**：

1. **Argon2id 高成本**：
   - 单次尝试耗时 100-200ms（64MB 内存）
   - 强密码（80-100 bits 熵）几乎无法暴力破解

2. **强主密码要求**：
   - 强制 12+ 字符
   - 混合字符类型
   - 密码熵 > 70 bits

3. **Salt 防御**：
   - 每个保管库 salt 独立
   - 无法使用预计算彩虹表

**破解成本估算**：

假设攻击者使用高端 GPU（RTX 4090）：
- Argon2id（64MB）在 GPU 上约 500ms/次
- 强密码空间：约 2^80
- **破解时间**：2^80 × 0.5s ≈ 3.8 × 10^16 年

**前提**：主密码必须强！

弱密码示例（如 `Password123!`）可能在几小时内被破解。

---

## 备份与灾难恢复

### 备份策略

⚠️ **重要**：如果丢失 `~/.gpasswd/` 目录且没有备份，数据无法恢复。

**推荐备份方法**：

1. **本地备份**：
   ```bash
   # 手动备份
   cp -r ~/.gpasswd ~/.gpasswd.backup.$(date +%Y%m%d)

   # 或使用 Time Machine（macOS）
   ```

2. **加密云备份**（未来版本）：
   ```bash
   # 数据已加密，可安全存储到云端
   rsync -av ~/.gpasswd/ ~/Dropbox/gpasswd-backup/
   ```

3. **Git 仓库**（高级用户）：
   ```bash
   cd ~/.gpasswd
   git init
   git add vault.db config.yaml
   git commit -m "Backup $(date)"
   git push
   ```

### 灾难恢复

**场景 1：忘记主密码**
- ❌ **无法恢复**（设计如此）
- 建议：将主密码写在纸上，存放保险箱

**场景 2：数据库文件损坏**
- 从备份恢复 `vault.db`
- 如果没有备份：数据无法恢复

**场景 3：配置文件丢失**
- 配置文件可重建（不含敏感信息）
- 数据库文件未损坏即可继续使用

**场景 4：电脑丢失/被盗**
- 如果启用 FileVault，数据相对安全
- 攻击者仍需暴力破解主密码
- 尽快从备份恢复到新设备

---

## 威胁模型

### 在威胁模型范围内

✅ **我们防护的攻击**：

1. **数据库文件泄露**：加密保护
2. **弱密码攻击**：Argon2id + 强度要求
3. **彩虹表攻击**：Salt
4. **数据篡改**：GCM 认证标签
5. **剪贴板遗留**：自动清除
6. **会话劫持**：超时保护

### 不在威胁模型范围内

❌ **我们无法防护的攻击**：

1. **键盘记录器**：依赖操作系统安全
2. **屏幕截图恶意软件**：使用 `reveal` 时有风险
3. **内存转储攻击**：会话期间密钥在内存中
4. **物理访问攻击**：解锁的电脑
5. **供应链攻击**：依赖第三方库的安全
6. **社会工程学**：钓鱼、诈骗

### 安全边界

```
┌─────────────────────────────────────────┐
│         gpasswd 安全边界                 │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  加密数据库 (vault.db)           │   │
│  │  • AES-256-GCM 加密             │   │
│  │  • Argon2id 密钥派生            │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  内存中的密钥                    │   │
│  │  • 会话管理                     │   │
│  │  • 超时自动清除                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
            ↑                   ↑
            │                   │
    依赖操作系统        依赖用户行为
    • FileVault         • 强主密码
    • 防病毒软件        • 及时 lock
    • 权限管理          • 定期备份
```

---

## 安全最佳实践

### 用户侧

1. **选择强主密码**：
   - 使用密码生成器
   - 密码短语（4-5 个随机单词）
   - 不要在其他地方重复使用

2. **保护主密码**：
   - 写在纸上，存放保险箱
   - 不要存储在电子设备上
   - 不要通过邮件/聊天软件发送

3. **物理安全**：
   - 启用 macOS FileVault
   - 设置屏幕自动锁定（< 5 分钟）
   - 离开电脑时执行 `gpasswd lock`

4. **定期备份**：
   - 每周备份 `~/.gpasswd/` 目录
   - 测试备份可恢复性

5. **环境安全**：
   - 在私密环境使用（避免肩窥）
   - 使用 `reveal` 时确保无摄像头/录屏
   - 公共场所使用时缩短会话超时

### 开发者侧

1. **依赖项审计**：
   - 定期检查依赖库漏洞
   - 使用 `go mod verify`

2. **代码审查**：
   - 所有加密相关代码必须审查
   - 禁止硬编码密钥/密码

3. **测试**：
   - 加密/解密单元测试
   - 边界条件测试（空密码、超长输入）

4. **安全编码**：
   - 使用 `crypto/rand`（不是 `math/rand`）
   - 避免自定义加密算法
   - 遵循 Go Security Guidelines

---

## 已知限制

### 技术限制

1. **Go 语言内存管理**：
   - 无法保证密钥立即从内存清除
   - GC 可能保留多个副本
   - 建议：尽量缩短会话时间

2. **剪贴板机制**：
   - macOS 剪贴板历史可能记录
   - 第三方应用可监控剪贴板
   - 建议：敏感环境使用 `reveal`

3. **SQLite 明文字段**：
   - 条目名称、分类、标签未加密
   - 权衡搜索性能和隐私
   - 未来：考虑加密搜索方案

### MVP 范围限制

1. **无密钥文件**：
   - 仅依赖主密码
   - 未来：可选的第二因素（密钥文件）

2. **无审计日志**：
   - 不记录访问历史
   - 未来：可选的加密日志

3. **无密码历史**：
   - 编辑密码时不保留历史版本
   - 未来：版本历史功能

---

## 安全漏洞报告

如果你发现安全漏洞，请**不要公开披露**。

**报告方式**：
- 邮件：security@gpasswd.dev
- GitHub Security Advisory（私有）

**承诺**：
- 48 小时内响应
- 修复后公开感谢（如你同意）
- 遵循负责任披露原则

---

## 参考标准与资源

### 加密标准
- [NIST SP 800-38D](https://csrc.nist.gov/publications/detail/sp/800-38d/final) - AES-GCM
- [RFC 9106](https://datatracker.ietf.org/doc/html/rfc9106) - Argon2
- [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)

### 密码管理器安全
- [1Password Security Design](https://1password.com/files/1Password-White-Paper.pdf)
- [Bitwarden Security Whitepaper](https://bitwarden.com/help/bitwarden-security-white-paper/)

### Go 安全
- [Go Security Policy](https://go.dev/security/policy)
- [Go Cryptography Guidelines](https://golang.org/pkg/crypto/)

---

**文档版本**：v1.0
**最后更新**：2026-01-13
